<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Map with Clustering</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <style>
        #map { width: 100%; height: 600px; }
    </style>
</head>
<body>
<h1>클러스터링 데모</h1>

<div>
    <label>DBSCAN eps(km): <input type="number" id="epsInput" value="3" /></label>
    <label>minPts: <input type="number" id="minPtsInput" value="2" /></label>
    <button onclick=runDbscan(`smile`)>SMILE - DBSCAN 실행</button>
    <button onclick=runDbscan(`elki`)>ELKI - DBSCAN 실행</button>
    <br />
    <label>K-Means K: <input type="number" id="kInput" value="3" /></label>
    <button onclick=runKmeans(`smile`)>SMILE - K-Means 실행</button>
    <button onclick=runKmeans(`elki`)>ELKI - K-Means 실행</button>
    <br>
    <button onclick="deleteAllNodes()" style="margin-left:20px; color:red;">
        Delete All Nodes
    </button>
</div>

<div id="map"></div>

<script>
    // 지도 초기화
    const map = L.map('map').setView([37.45, 127.2], 8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data © OpenStreetMap'
    }).addTo(map);

    // 마커 저장 배열
    let markers = [];

    // 지도 클릭 이벤트 -> 서버에 (lat,lng) 추가
    map.on('click', function(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        // 서버 /locations POST
        fetch('/locations', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ latitude: lat, longitude: lng })
        })
            .then(res => {
                if(!res.ok) throw new Error('Insert failed');
                return res.json();
            })
            .then(data => {
                console.log('Inserted:', data);
                // 클러스터링 전이므로 cluster_label=null
                // 다시 표시
                loadLocations();
            })
            .catch(err => console.error(err));

    });

    // 마커 색상
    function getColor(label) {
        if(label === null || label < 0) return 'gray'; // noise or null
        // 라벨에 따라 HSL 색상
        const hue = (label * 137.508) % 360;
        return `hsl(${hue}, 70%, 50%)`;
    }

    // /locations fetch 후, 지도 마커 표시
    function loadLocations() {
        fetch('/locations')
            .then(res => res.json())
            .then(data => {
                // 기존 마커 제거
                markers.forEach(m => map.removeLayer(m));
                markers = [];

                data.forEach(loc => {
                    const color = getColor(loc.clusterLabel);
                    const marker = L.circleMarker([loc.latitude, loc.longitude], {
                        radius: 7,
                        color: color,
                        fillColor: color,
                        fillOpacity: 0.8
                    }).addTo(map)
                        .bindPopup(`ID: ${loc.id}<br>Label: ${loc.clusterLabel}`);
                    markers.push(marker);
                });
            })
            .catch(err => console.error(err));


    }
    // DBSCAN 실행
    function runDbscan(lib) {
        const eps = document.getElementById('epsInput').value;
        const minPts = document.getElementById('minPtsInput').value;
        fetch(`/cluster/`+lib+`/dbscan?radius=${eps}&minPts=${minPts}`)
            .then(res => res.text())
            .then(msg => {
                console.log(msg);
                // 클러스터링 완료 후 로케이션 재로드
                loadLocations();
            })
            .catch(err => console.error(err));
    }

    // K-Means 실행
    function runKmeans(lib) {
        const k = document.getElementById('kInput').value;
        fetch(`/cluster/`+lib+`/kmeans?k=${k}`)
            .then(res => res.text())
            .then(msg => {
                console.log(msg);
                loadLocations();
            })
            .catch(err => console.error(err));
    }

    // ** Delete All Nodes (NEW) **
    function deleteAllNodes() {
        if(!confirm("정말 모든 노드를 삭제하시겠습니까?")) return;
        fetch('/locations', {
            method: 'DELETE'
        })
            .then(res => {
                if(!res.ok) throw new Error('Delete failed');
                return res.text();
            })
            .then(msg => {
                console.log(msg);
                loadLocations();  // 지도 마커 갱신 -> 전부 없어짐
            })
            .catch(err => console.error(err));
    }

    // 초기 로딩
    loadLocations();
</script>
</body>
</html>